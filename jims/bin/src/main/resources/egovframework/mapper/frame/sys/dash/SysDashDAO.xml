<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!--
    SQL File Name : SysDashDAO.xml
    Description : 대시보드 
    Author : jmkim
    Since : 2021.04.14
-->

<mapper namespace="sysDashDAO">
	
	

	<!--  대시보드 월별 분석자료 추이 -->
    <select id="querySysDashIDtlMonAnal" parameterType="java.util.HashMap" resultType="egovMap">
    	/* sysDashDAO.querySysDashIDtlMonAnal 대시보드 월별 분석자료 추이 */
		SELECT  M.MON,IFNULL(A.CNT,0) CNT
		  FROM ( SELECT DATE_FORMAT(D, '%Y%m') MON
		           FROM (
		                     SELECT @RNUM:=@RNUM+1 AS ROWNUM, DATE(ADDDATE(CONCAT(DATE_FORMAT(CURDATE(), '%Y'),'-01-01'), INTERVAL @RNUM MONTH)) AS D
		                       FROM (SELECT @RNUM:=-1) R, CODE
		        ) T
		 WHERE YEAR(D) <![CDATA[<]]> 2022 ) M 
		  LEFT OUTER JOIN (
		                     SELECT SUBSTR(REQ_DT,1,6) MON,COUNT(*) CNT 
		                       FROM ANALYSIS_SUPP_REQ
		                      WHERE REQ_DT LIKE CONCAT(DATE_FORMAT(CURDATE(), '%Y'),'%')
		                      GROUP BY SUBSTR(REQ_DT,1,6)
		                   ) A ON M.MON = A.MON
		 ORDER BY 1
    </select>
    
    
    <!--  신규 분석 요청 현황 -->
    <select id="querySysDashIDtlReqInfo" parameterType="java.util.HashMap" resultType="egovMap">
    	/* sysDashDAO.querySysDashIDtlReqInfo 대시보드 월별 분석자료 추이 */
    
	   select (select max(k.CD_NM)
		         from ANALYSIS_EVDC_DTL j , CODE_DTL k 
		        where j.CFSC_GOODS_DIV = k.CD
		          and j.ANAL_REQ_SNO =a.ANAL_REQ_SNO
		          and k.CD_ID ='C05') cd_nm
		          ,b.DEPT_NM
		          , c.INCDT_NM
		 from ANALYSIS_SUPP_REQ a, INSTT b,INCIDENT c
		where a.pgs_stat ='C03003' 
		  and a.REQ_INSTT_CD = b.INSTT_CD
		  and a.INCDT_SNO = c.INCDT_SNO
		order by a.reg_dt desc
		limit 4
		
    </select>
    
    
    <!--  분석관별 실적 -->
    <select id="querySysDashIDtlAnalInfo" parameterType="java.util.HashMap" resultType="egovMap">
    	/* sysDashDAO.querySysDashIDtlAnalInfo 분석관별 실적 */
    <![CDATA[
	   select a.ANAL_CRGR_ID 
		     , sum( case when a.ANAL_STAT = 'C06003' then 1 else 0 end) prg 
		     , sum( case when a.ANAL_STAT <> 'C06003' then 1 else 0 end) end 
		 from ANALYSIS_RSLT a 
		where a.ANAL_END_DT between CONCAT(DATE_FORMAT(CURDATE(), '%Y'),'-01-01') and last_day( CONCAT(DATE_FORMAT(CURDATE(), '%Y'),'-12-01'))
		group by anal_crgr_id
       ]]>
		
    </select>
	
	
	<!--  매체별 분석 지원 현황 -->
    <select id="querySysDashIDtlMediaInfo" parameterType="java.util.HashMap" resultType="egovMap">
    	/* sysDashDAO.querySysDashIDtlMediaInfo 매체별 분석 지원 현황 */
    <![CDATA[
	    select CD_NM  media, round(cnt*100/tot) perc
          from (
		select c.CD_NM , count(*) cnt ,IFNULL(( select case when count(*) =0 then 1 else count(*) end from ANALYSIS_EVDC_DTL ),1) tot
		 from ANALYSIS_SUPP_REQ a , ANALYSIS_EVDC_DTL b, CODE_DTL c
		where a.ANAL_REQ_SNO = b.ANAL_REQ_SNO
		  and b.CFSC_GOODS_DIV = c.CD
		  and c.CD_ID ='C05'
		  and a.RCV_DT_ACP  between CONCAT(DATE_FORMAT(CURDATE(), '%Y'),'-01-01') and last_day( CONCAT(DATE_FORMAT(CURDATE(), '%Y'),'-12-01'))
		group by c.CD_NM
		) b
       ]]>
		
    </select>
    
    <!-- @!@ 장비 지원 현황 -->
    <select id="querySysDashIDtlEqpInfo" parameterType="java.util.HashMap" resultType="egovMap">
    	/* sysDashDAO.querySysDashIDtlEqpInfo 장비 지원 현황 */
    	SELECT
			FN_GET_CODENM(CD.CD) AS CD_NM
			,NVL(EQP.EQP_CNT, 0) AS EQP_CNT
		FROM
			CODE_DTL CD LEFT OUTER JOIN(
			SELECT
				EM.EQP_TYP
				,COUNT(EM.EQP_TYP) AS EQP_CNT
			FROM
				EQUIPMENT_MGMT EM LEFT OUTER JOIN EQP_RENTAL_DTL ERD ON EM.EQP_SNO = ERD.EQP_SNO AND EM.USE_YN = 'Y' AND ERD.USE_YN = 'Y'
			WHERE
				1 = 1
			AND
				ERD.PGS_STAT = 'C09002'
			GROUP BY
				EM.EQP_TYP) EQP ON CD.CD = EQP.EQP_TYP AND CD.USE_YN = 'Y'
		WHERE
			1 = 1
		AND
			CD.CD_ID = 'C14'
		ORDER BY
			CD.CD DESC
    </select>
	
	<!-- @!@ 대시보드관리 조회 -->
    <select id="querySysDashUDtl" parameterType="java.util.HashMap" resultType="egovMap">
    	/* querySysDashUDtl @!@ 대시보드관리 조회 */
    	SELECT
			USER_GB
			,DASH_GB
			,DASH_ORDER
			,USE_YN
			,REG_DT
			,REGR_ID
			,UPD_DT
			,UPDR_ID
		FROM
			DASH_COMPT
		WHERE
			1 = 1
		AND
			USER_GB = #{userGb}
		ORDER BY
			DASH_ORDER
    </select>
	
	<!-- @!@ 대시보드관리 저장 -->
    <insert id="regSysDashUDtl" parameterType="java.util.HashMap">
	/* regSysDashUDtl @!@ 대시보드관리 저장 */                          
     INSERT INTO
     	DASH_COMPT (
     		USER_GB
			,DASH_GB
			,DASH_ORDER
			,USE_YN
			,REG_DT
			,REGR_ID
		)
		VALUES (
			#{userGb}
			,#{dashGb}
			,#{dashOrder}
			,#{useYn}
			,NOW()
			,#{session_userid}
		)
		ON DUPLICATE KEY UPDATE  
			DASH_ORDER	=	#{dashOrder}
			,USE_YN	=	#{useYn}
			,UPD_DT	=	NOW()
			,UPDR_ID	=	#{session_userid}
    </insert>
    
</mapper>
