<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!--
   SQL File Name : fBbsNtcDAO.xml
   Description : 공지사항 관련
   Author : leeji
   Since : 2021.04.17
-->
<mapper namespace="fBbsNtcDAO">

    <sql id="conditionList">
        <if test="searchType != null and searchType != '' ">
            <if test="searchValue != null and searchValue != '' ">
                <if test='searchType.equals("all")'>                     
                     AND (A.TITLE LIKE  CONCAT('%' , #{searchValue} , '%') OR  (SELECT USER_NM FROM USER WHERE USER_ID = A.REGR_ID) like CONCAT('%' , #{searchValue} , '%') OR  CNTS LIKE CONCAT('%' , #{searchValue} , '%') )                                          
                </if>                
                <if test='searchType.equals("ttandsj")'>
                     AND (A.TITLE LIKE  CONCAT('%' , #{searchValue} , '%') OR  CNTS LIKE CONCAT('%' , #{searchValue} , '%'))
                </if>
                <if test='searchType.equals("searchRegerNm")'>
                     AND (SELECT USER_NM FROM USER WHERE USER_ID = A.REGR_ID) like CONCAT('%' , #{searchValue} , '%')
                </if>
                <if test='searchType.equals("searchTitle")'>
                     AND A.TITLE LIKE  CONCAT('%' , #{searchValue} , '%')
                </if>
                <if test='searchType.equals("searchCnts")'>
                     AND A.CNTS LIKE  CONCAT('%' , #{searchValue} , '%')
                </if>
            </if>
            <if test="codeType != null and codeType != '' ">
                AND A.CNTS_TYP LIKE  CONCAT('%' , #{codeType} , '%')
            </if>
        </if>
    </sql>
    
 	<!-- 공지사항 리스트 조회 -->
     <select id="selectFBbsNtcList" parameterType="java.util.HashMap" resultType="egovMap">
        /* fBbsNtcDAO.selectFBbsNtcList 공지사항 리스트 조회 */
                     SELECT
                            A.PUTUP_SNO
                           , A.GRP_NO
                           , A.LVL_NO
                           , FN_GET_CODENM (A.CNTS_TYP) AS CNTS_TYP
                           , A.TITLE
                           , (SELECT CNTS FROM BOARD WHERE PUTUP_SNO=A.PUTUP_SNO ) AS CNTS
                           , DATE_FORMAT(A.PUTUP_DT, '%Y.%m.%d') AS PUTUP_DT
                           , A.ADMIN_ID
                           , (SELECT USER_NM FROM USER WHERE USER_ID = A.ADMIN_ID) AS ADMIN_NM
                           , A.USER_GB
                           ,'' AS USER_DIV_NM
                           , A.SELECT_NUM
                           , A.FIX_NOTICE_YN
                           , A.BOARD_KIND
                           , A.ATCH_FILE_ID
                           , A.USE_YN
                           , A.REGR_ID
                           , (SELECT USER_NM FROM USER WHERE USER_ID = A.REGR_ID) AS REGR_NM
                           , A.UPD_DT
                           , A.UPDR_ID
                           , (SELECT USER_NM FROM USER WHERE USER_ID = A.UPDR_ID) AS UPDR_NM                          
                           , (
                                SELECT COUNT(*) COMT_CNT
                                  FROM BOARD_COMT
                                 WHERE PUTUP_SNO=A.PUTUP_SNO
                                   AND USE_YN = 'Y'
                             ) AS COMT_COUNT
                           , (
                                SELECT COUNT(*) FILE_COUNT
                                  FROM ATCH_FILE_DTL
                                 WHERE ATCH_FILE_ID=A.ATCH_FILE_ID
                                   AND USE_YN = 'Y'
                             ) AS FILE_COUNT
                     FROM    BOARD A
                     WHERE A.USE_YN     = 'Y'                           
                       AND A.BOARD_KIND = #{boardKind}
                    <if test="searchFixNoticeYn != null and searchFixNoticeYn != '' ">
                       AND A.FIX_NOTICE_YN = #{searchFixNoticeYn}
                    </if>
                    <include refid="conditionList"/>
                     GROUP BY A.PUTUP_SNO
                           , A.GRP_NO
                           , A.CNTS_TYP
                           , A.LVL_NO
                           , A.TITLE
                           , A.PUTUP_DT
                           , A.ADMIN_ID
                           , A.USER_GB
                           , A.SELECT_NUM
                           , A.FIX_NOTICE_YN
                           , A.BOARD_KIND
                           , A.ATCH_FILE_ID
                           , A.USE_YN
                           , A.REGR_ID
                           , A.UPD_DT
                           , A.UPDR_ID
                           , A.REG_DT
                     ORDER BY                      
                        A.FIX_NOTICE_YN DESC,A.PUTUP_SNO DESC
            LIMIT #{pageStart}, #{perPageNum}

    </select>

	<!-- 공지사항 리스트 조회 카운트 -->
    <select id="selectFBbsNtcListCnt" parameterType="java.util.HashMap" resultType="int">
        /* fBbsNtcDAO.selectFBbsNtcListCnt 공지사항 리스트 조회 카운트*/
        SELECT COUNT(DISTINCT A.PUTUP_SNO) AS TOTCNT
          FROM BOARD A
         WHERE A.USE_YN     = 'Y'
           AND A.BOARD_KIND = #{boardKind}
         <include refid="conditionList"/>
         
    </select>
    
    <!-- 공지사항 상세보기 -->
    <select id="selectFBbsNtcRDtl" parameterType="java.util.HashMap" resultType="egovMap">
    /* fBbsNtcDAO.selectNotice 공지사항 상세보기 */
    SELECT      
 		   A.PUTUP_SNO
           , A.GRP_NO
           , A.LVL_NO
           , A.TITLE
           ,(SELECT CNTS FROM BOARD WHERE PUTUP_SNO=A.PUTUP_SNO ) AS CNTS           
           , DATE_FORMAT(A.PUTUP_DT, '%Y.%m.%d') AS PUTUP_DT
           , A.ADMIN_ID
           , (SELECT USER_NM FROM USER WHERE USER_ID = A.ADMIN_ID ) AS ADMIN_NM
           , A.USER_GB
           ,'' AS USER_DIV_NM
           , A.SELECT_NUM
           , A.FIX_NOTICE_YN
           , A.BOARD_KIND
           , A.ATCH_FILE_ID
           , A.USE_YN
           , A.REGR_ID
           , A.CNTS_TYP
           , (SELECT USER_NM FROM USER WHERE USER_ID = A.REGR_ID) AS REGR_NM
           , A.UPD_DT
           , A.UPDR_ID
           , (SELECT USER_NM FROM USER WHERE USER_ID = A.UPDR_ID) AS UPDR_NM           
           , A.REG_DT
           , (
                SELECT COUNT(*) COMT_CNT
                  FROM BOARD_COMT
                 WHERE PUTUP_SNO=A.PUTUP_SNO
                   AND USE_YN = 'Y'
             ) AS COMT_COUNT
           , (
                SELECT COUNT(*) FILE_COUNT
                  FROM ATCH_FILE_DTL
                 WHERE ATCH_FILE_ID=A.ATCH_FILE_ID
                   AND USE_YN = 'Y'
             ) AS FILE_COUNT
     FROM    BOARD A
     WHERE A.USE_YN     = 'Y'     
     AND A.PUTUP_DT IS NOT NULL
     AND PUTUP_SNO = #{putupSno}
     GROUP BY A.PUTUP_SNO
           , A.GRP_NO
           , A.LVL_NO
           , A.TITLE
           , A.PUTUP_DT
           , A.ADMIN_ID
           , A.USER_GB
           , A.SELECT_NUM
           , A.FIX_NOTICE_YN
           , A.BOARD_KIND
           , A.ATCH_FILE_ID
           , A.USE_YN
           , A.REGR_ID
           , A.UPD_DT
           , A.UPDR_ID
           , A.CNTS_TYP
           , A.REG_DT
    </select>

    <!-- 공지사항 조회수 update -->
    <update id="updateFBbsNtcCount">
     /* fBbsNtcDAO.updateFBbsNtcCount 공지사항 조회수 update */
      UPDATE BOARD
         SET SELECT_NUM = SELECT_NUM + 1
       WHERE PUTUP_SNO = #{putupSno}
    </update>

	<!-- 공지사항 게시판사용자 조회 -->
    <select id="selectFBbsNtcUser" parameterType="java.util.HashMap" resultType="String">
        /* fBbsNtcDAO.selectFBbsNtcUser 공지사항 게시판사용자 조회 */
        SELECT USER_ID AS REGR_ID
          FROM USER
         WHERE USER_ID = #{regrId}
    </select>

	<!-- 사용자 그룹 조회 -->
    <select id="selectUserGb" parameterType="String" resultType="String">
        /* fBbsNtcDAO.selectUserGb 사용자 그룹 조회*/
        SELECT
            USER_GB
        FROM USER
        WHERE 1=1
        AND USER_ID = #{userId}
        AND USE_YN = 'Y'
    </select>

    <!-- 공지사항 등록 -->
    <insert id="insertFBbsNtc"  parameterType="java.util.HashMap">
    <selectKey resultType="int" keyProperty="putupSno" order="BEFORE">
          SELECT NEXTVAL(TB_BOARD_SEQ)
    </selectKey>
    /* fBbsNtcDAO.insertFBbsNtc 공지사항 등록 */
    INSERT INTO BOARD(
           PUTUP_SNO
          , GRP_NO
          , LVL_NO
          , TITLE
          , CNTS
          <if test="putupDt != null and putupDt != '' ">
          , PUTUP_DT
          </if>
          <if test="adminId != null and adminId != '' ">
          , ADMIN_ID
          </if>
          <if test="userGb != null and userGb != '' ">
          , USER_GB
          </if>
          , SELECT_NUM
          , FIX_NOTICE_YN
          , BOARD_KIND
          , ATCH_FILE_ID
          , USE_YN
          , REGR_ID
          , UPD_DT
          , UPDR_ID
          , REG_DT
          <if test="cntsTyp != null and cntsTyp != '' ">
          , CNTS_TYP
          </if>
           )
    VALUES (
           #{putupSno}
          ,#{putupSno}
          <if test="lvlNo != null and lvlNo != '' ">
          , #{lvlNo}
          </if>
          <if test="lvlNo == null or lvlNo == '' ">
          , '0'
          </if>           
          , #{title}
          , #{cnts}          
          <if test="putupDt != null and putupDt != '' ">
          , #{putupDt}
          </if>          
          <if test="adminId != null and adminId != '' ">
          , #{adminId}
          </if>
          <if test="userGb != null and userGb != '' ">
          , #{userGb}
          </if>
          , 0
          <if test="fixNoticeYn != null and fixNoticeYn != '' ">
          , 'Y'
          </if>
          <if test="fixNoticeYn == null or fixNoticeYn == '' ">
          , 'N'
          </if>
          , #{boardKind}
          , #{atchFileId}
          <if test="useYn != null and useYn != '' ">
          , #{useYn}
          </if>
          <if test="useYn == null or useYn == '' ">
          , 'Y'
          </if>
          , #{regrId}
          , NOW()
          , #{regrId}
          , NOW()
          <if test="cntsTyp != null and cntsTyp != '' ">
          , #{cntsTyp}
          </if>
           )
    </insert>

    <!-- 공지사항 수정 -->
    <update id="updateFBbsNtc">
    /* fBbsNtcDAO.updateFBbsNtc 공지사항 수정*/
    UPDATE BOARD
            SET UPD_DT    = NOW()
              , UPDR_ID    = <if test="updrId != null and updrId != '' ">#{updrId}</if><if test="updrId == null or updrId == '' ">#{regrId}</if>
            <if test="title != null and title != '' ">
              , TITLE         = #{title}
            </if>
            <if test="cnts != null and cnts != '' ">
              , CNTS          = #{cnts}
            </if>            
            <if test="putupDt != null and putupDt != '' ">
               , PUTUP_DT      = #{putupDt}
            </if>
            <if test="atchFileId != null and atchFileId != '' ">
               , ATCH_FILE_ID  = #{atchFileId}
            </if>
            <if test="useYn != null and useYn != '' ">
               , USE_YN    = #{useYn}
            </if>
            <if test="cntsTyp != null and cntsTyp != '' ">
               , CNTS_TYP = #{cntsTyp}
            </if>
            <if test="fixNoticeYn != null and fixNoticeYn != '' ">
                , FIX_NOTICE_YN = 'Y'
            </if>
            <if test="fixNoticeYn == null or fixNoticeYn == '' ">
                , FIX_NOTICE_YN = 'N'
            </if>
    WHERE PUTUP_SNO     = #{putupSno}
    </update>

    <!-- 게시판 글 삭제 -->
    <update id="deleteFBbsNtc">
        /* fBbsNtcDAO.deleteFBbsNtc 공지사항 삭제*/
        UPDATE BOARD
           SET USE_YN = 'N'
         WHERE PUTUP_SNO = #{putupSno}           
    </update>

</mapper>
