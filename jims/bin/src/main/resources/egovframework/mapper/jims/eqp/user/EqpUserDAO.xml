<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="eqpUserDAO">

	<!-- 장비 사용자 관리 검색 조건-->
    <sql id="WeqpUserList">
            <if test="schEqpNm != null and schEqpNm != '' ">
                AND B.EQP_NM LIKE  CONCAT('%' , #{schEqpNm} , '%')
            </if>
            <if test="schEqpUserNm != null and schEqpUserNm != '' ">
                AND EXISTS (
			   					SELECT *
			   					  FROM USER TA
			   					 WHERE TA.USER_ID = A.USER_ID 
			   					   AND TA.USER_NM LIKE  CONCAT('%' , #{schEqpUserNm} , '%')
			               ) 
            </if>    
            <if test="schEqpTyp != null and schEqpTyp != '' ">
                AND B.EQP_TYP = #{schEqpTyp}
            </if>
            <if test="schMdlNm != null and schMdlNm != '' ">
                AND B.MDL_NM LIKE  CONCAT('%' , #{schMdlNm} , '%')
            </if>
            <if test="schPgsStat != null and schPgsStat != '' ">
                AND A.PGS_STAT  = #{schPgsStat}
            </if>
            
    </sql>
    
 	 <!-- 장비 사용자 관리 조회 -->
     <select id="eqpUserMList" parameterType="java.util.HashMap" resultType="egovMap">
        /* eqpUserDAO.eqpUserMList 장비 사용자 관리 조회 */
        	SELECT *
        	  FROM (
        	  			SELECT A.EQP_USER_SNO
						       , (
								    SELECT TA.USER_NM
								      FROM USER TA
								     WHERE TA.USER_ID = A.USER_ID
							  	 ) AS EQP_USER_NM
							   , A.EQP_SNO AS eqpSno
						       , B.EQP_NM
						       , FN_GET_CODENM(B.EQP_TYP) AS EQP_TYP_NM
						       , B.MNFT_CO
						       , B.MDL_NM
						       , A.RCV_DT
						       , A.RTN_DT
						       , B.HLD_PLC
						       , A.PGS_STAT
						       , FN_GET_CODENM(A.PGS_STAT) AS PGS_STAT_NM
						       , A.REG_DT
						       , A.USER_ID
						  FROM EQP_USER_DTL A
						       , EQUIPMENT_MGMT B
						 WHERE A.EQP_SNO = B.EQP_SNO
                           AND A.USE_YN = 'Y'
                           AND B.USE_YN = 'Y'
						 <include refid="WeqpUserList"/>
        	       ) A
        	 ORDER BY A.REG_DT ASC  		
             LIMIT #{pageStart}, #{perPageNum}
        	

    </select>
	
	<!-- 장비 사용자 관리 조회 TotalCnt -->
    <select id="eqpUserMListTotCnt" parameterType="java.util.HashMap" resultType="int">
        /* eqpUserDAO.eqpUserMListTotCnt 장비 사용자 관리 조회 TotalCnt */
        	SELECT COUNT(A.EQP_USER_SNO) AS TOTCNT
        	  FROM (
        	  			SELECT A.EQP_USER_SNO
						       , (
								    SELECT TA.USER_NM
								      FROM USER TA
								     WHERE TA.USER_ID = A.USER_ID
							  	 ) AS EQP_USER_NM
						       , B.EQP_NM
						       , FN_GET_CODENM(B.EQP_TYP) AS EQP_TYP_NM
						       , B.MNFT_CO
						       , B.MDL_NM
						       , A.RCV_DT
						       , A.RTN_DT
						       , B.HLD_PLC
						       , A.PGS_STAT
						       , FN_GET_CODENM(A.PGS_STAT) AS PGS_STAT_NM
						  FROM EQP_USER_DTL A
						       , EQUIPMENT_MGMT B
						 WHERE A.EQP_SNO = B.EQP_SNO
                           AND A.USE_YN = 'Y'
                           AND B.USE_YN = 'Y'
						 <include refid="WeqpUserList"/>
        	       ) A
        
    </select>
    
    <!-- 사용자 리스트 조회 -->
	<select id="eqpUserListPop" parameterType="java.util.HashMap" resultType="egovMap">
      /* eqpUserDAO.eqpUserListPop 사용자 리스트 조회*/
	  SELECT T.*
	  , ROW_NUMBER() OVER(ORDER BY T.INSTT_CD , T.USER_GB) RN FROM (
	      SELECT
	      	CONCAT(c.DEPT_NM, ' ', c.TEAM_NM ) DEPT_NM
	  	     , CONCAT(b.USER_NM, '(',IFNULL(b.TEL_NO,''), IF(b.HP_TEL_NO IS NULL ,'', CONCAT(',', b.HP_TEL_NO)), ')') REG_USER_NM
	  	     , b.TEL_NO 
	  	     , b.HP_TEL_NO 
	  	     , a.USER_ID REG_USER_ID
	  	     , b.USER_NM
	  	     , b.INSTT_CD 
	  	     , b.USER_GB
	  	  FROM DEPT_USER a JOIN USER b
	  	    ON (a.USER_ID = b.USER_ID AND a.USE_YN = 'Y' AND b.USE_YN ='Y')
	  	  JOIN INSTT c 
	  	    ON (a.INSTT_CD = c.INSTT_CD AND c.USE_YN = 'Y')
	        <where>
	        <if test="!insttCd.equals('G000000517')">
	      	AND a.INSTT_CD = #{insttCd}
	  	  <!--AND b.USER_GB = #{userGb}-->
	        </if>
	  	   <if test="searchUserNm != null and searchUserNm != '' ">
	  	   	AND b.USER_NM LIKE CONCAT('%', #{searchUserNm}, '%')
	  	   </if>
	  	   </where>
	  	    ORDER BY b.INSTT_CD , b.USER_GB
	        LIMIT #{pageStart}, #{perPageNum}  
	  ) T
	</select>
    
    	<!-- 사용자 리스트 조회 카운트 -->
	<select id="eqpUserListPopCnt" parameterType="java.util.HashMap" resultType="int">
      /* eqpUserDAO.eqpUserListPopCnt 사용자 리스트 조회 카운트*/
	  SELECT COUNT(*)
		FROM DEPT_USER a JOIN USER b
		  ON (a.USER_ID = b.USER_ID AND a.USE_YN = 'Y' AND b.USE_YN ='Y')
		JOIN INSTT c 
		  ON (a.INSTT_CD = c.INSTT_CD AND c.USE_YN = 'Y')
	    <where>
	    <if test="!insttCd.equals('G000000517')">
	  	AND a.INSTT_CD = #{insttCd}
		<!--AND b.USER_GB = #{userGb}-->
	    </if>
		 <if test="searchUserNm != null and searchUserNm != '' ">
		 	AND b.USER_NM LIKE CONCAT('%', #{searchUserNm}, '%')
		 </if>
		 </where>
	</select>
    
    <!-- 장비보유일련번호 조회 -->
    <select id="selectEqpUserSno" parameterType="java.util.HashMap" resultType="String">
        /* eqpUserDAO.selectEqpUserSno 장비보유일련번호 조회 */
        
        SELECT CONCAT('E',DATE_FORMAT(NOW(), '%Y%m'),LPAD(IFNULL(MAX(SUBSTR(A.EQP_USER_SNO,8,3)),0) +1,3,'0')) FROM EQP_USER_DTL A
    </select>

    <!-- 장비 사용자 관리 등록 -->
    <insert id="regEqpUserRDtl" parameterType="java.util.HashMap">
    	/* eqpUserDAO.regEqpUserRDtl 장비 사용자 관리 등록 */
    	
    	 INSERT EQP_USER_DTL (
											  EQP_USER_SNO
											, INSTT_CD
											, USER_ID
											, EQP_SNO
											, PGS_STAT
											, RCV_DT
											, RTN_DT
											, USE_YN
											, REG_DT
											, REGR_ID
											, UPD_DT
											, UPDR_ID
										)
								VALUES (
											  #{eqpUserSno}
											, #{insttCd}
											, #{userId}
											, #{eqpSno}
											, #{pgsStat}
											, REPLACE(#{rcvDt},'-','')
											, REPLACE(#{rtnDt},'-','')
											, 'Y'
											, REPLACE(DATE_FORMAT(NOW(), '%Y%m%d'),'-','')
								            , #{session_userid}
								            , REPLACE(DATE_FORMAT(NOW(), '%Y%m%d'),'-','')
								            , #{session_userid}
								       )
    </insert>

	<!-- 장비 사용자 관리 등록 -> 부서별 사용자 현재사업명 수정  -->
    <update id="updEqpUserBiz" parameterType="java.util.HashMap">
	UPDATE DEPT_USER
	SET NOW_BIZ_NM = #{nowBizNm}
		, UPD_DT = now()
		, UPDR_ID = #{session_userid}
	WHERE USER_ID = #{userId}
	</update>

	<!-- 장비 사용자 관리 상세  -->
	<select id="queryEqpUserUDtl" parameterType="java.util.HashMap" resultType="egovMap">
		select
			c.INSTT_NM insttNm
			, c.INSTT_CD insttCd
			, c.DEPT_NM
			, d.USER_NM userNm
			, a.USER_ID userId
			, a.PGS_STAT pgsStat
			, FN_GET_CODENM(em.EQP_TYP) eqpTypNm
			, em.SR_NO
			, em.MDL_NM
			, em.MNFT_CO
			, em.PURC_DT
			, em.EQP_NM 
			, em.HLD_PLC 
			, b.NOW_BIZ_NM nowBizNm
			, a.RCV_DT rcvDt
			, a.RTN_DT rtnDt
			, a.EQP_SNO eqpSno
			, a.EQP_USER_SNO eqpUserSno
		from EQP_USER_DTL a
		join DEPT_USER b
			on (a.USER_ID = b.USER_ID and a.INSTT_CD = b.INSTT_CD )
		join INSTT c
			on (b.INSTT_CD = c.INSTT_CD )
		join `USER` d
			on (b.USER_ID = d.USER_ID )
		join EQUIPMENT_MGMT em
			on (em.EQP_SNO = a.EQP_SNO)
		where a.USE_YN = 'Y'
			and a.EQP_USER_SNO = #{eqpUserSno}
	</select>

	<select id="queryEqpUDtl" parameterType="java.util.HashMap" resultType="egovMap">
        /* eqpUserDAO.queryEqpUDtl 장비관리 상세 조회 */
        
    select
		a.EQP_SNO as eqpSno
		, a.EQP_NM as eqpNm
		, a.SR_NO as srNo
		, a.EQP_TYP as eqpTyp
		, CASE a.EQP_TYP 
				 WHEN 'C05001' THEN (SELECT CD_NM FROM CODE_DTL WHERE CD = 'C05001')/*데스크탑*/
				 WHEN 'C05002' THEN (SELECT CD_NM FROM CODE_DTL WHERE CD = 'C05002')/*노트북*/
				 WHEN 'C05003' THEN (SELECT CD_NM FROM CODE_DTL WHERE CD = 'C05003')/*모니터*/
				 WHEN 'C05004' THEN (SELECT CD_NM FROM CODE_DTL WHERE CD = 'C05004')/*기타*/
				 WHEN 'C05005' THEN (SELECT CD_NM FROM CODE_DTL WHERE CD = 'C05005')/*가구*/
				 WHEN 'C05006' THEN (SELECT CD_NM FROM CODE_DTL WHERE CD = 'C05006')/*프린터*/
			END eqpTypNm
		, a.PURC_DT as purcDt
		, a.EXPR_DT as exprDt
		, a.MNFT_CO as mnftCo
		, a.MDL_NM as mdlNm
		, (
			select 
				ta.USER_NM 
			from USER ta, EQP_USER_DTL tb
			where 1=1
				and ta.USER_ID = tb.USER_ID
				and tb.EQP_SNO = a.EQP_SNO 
				and tb.PGS_STAT = 'C03001'
			) as userNm
	from EQUIPMENT_MGMT a
	where a.USE_YN = 'Y'
	and a.EQP_SNO = {#eqpSno}
	</select>
    
    <!-- 장비 사용자 관리 수정 -->
    <update id="updEqpUserUDtl" parameterType="java.util.HashMap">
        /* eqpUserDAO.updEqpUserUDtl 장비 사용자 관리 수정 */
    	
    	 INSERT EQP_USER_DTL (
											  EQP_USER_SNO
											, INSTT_CD
											, USER_ID
											, EQP_SNO
											, PGS_STAT
											, RCV_DT
											, RTN_DT
											, USE_YN
											, REG_DT
											, REGR_ID
											, UPD_DT
											, UPDR_ID
										)
								VALUES (
											  #{eqpUserSno}
											, #{insttCd}
											, #{userId}
											, #{eqpSno}
											, #{pgsStat}
											, REPLACE(#{rcvDt},'-','')
											, REPLACE(#{rtnDt},'-','')
											, 'Y'
											, REPLACE(DATE_FORMAT(NOW(), '%Y%m%d'),'-','')
								            , #{session_userid}
								            , REPLACE(DATE_FORMAT(NOW(), '%Y%m%d'),'-','')
								            , #{session_userid}
								       )
        
    </update>
    
    <!-- 장비 사용자 관리 삭제-->
	<delete id="delEqpUserUDtl" parameterType="java.util.HashMap">
        /* eqpUserDAO.delEqpUserUDtl 장비 사용자 관리 삭제 */
		DELETE FROM EQP_USER_DTL WHERE EQP_USER_SNO = #{eqpUserSno};
	</delete>
    
</mapper>
